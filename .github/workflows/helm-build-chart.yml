name: helm-charts
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  API_KEY: changeme
  OPENVASD: 127.0.0.1:3000

jobs:
  openvasd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Start a local k8s cluster
        uses: jupyterhub/action-k3s-helm@v3
        with:
          k3s-channel: latest
          metrics-enabled: false
      - name: deploy openvasd
        run: |
          helm uninstall openvasd || true 
          helm install openvasd charts/openvasd/ --values charts/openvasd/values.yaml
          kubectl rollout status --watch --timeout 600s deployment/openvasd
          helm test openvasd

         run: echo "POD_NAME=$(kubectl get pods --namespace default -l 'app.kubernetes.io/name=openvasd,app.kubernetes.io/instance=openvasd' -o jsonpath='{.items[0].metadata.name}')" >> $GITHUB_ENV
         run: echo "CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath='{.spec.containers[0].ports[0].containerPort}')" >> $GITHUB_ENV
         run: echo "kubectl --namespace default port-forward $POD_NAME 3000:$CONTAINER_PORT"
      - name: smoketest
        working-directory: rust/smoketest
        run: |
          make build run        
      - uses: greenbone/actions/helm-build-push@v3
        if: github.event_name == 'workflow_dispatch'
        with:
          chart-name: openvasd
          registry: ${{ vars.IMAGE_REGISTRY }}
          registry-subpath: helm-charts/
          registry-user: ${{ secrets.GREENBONE_BOT }}
          registry-token: ${{ secrets.GREENBONE_BOT_PACKAGES_WRITE_TOKEN }}
